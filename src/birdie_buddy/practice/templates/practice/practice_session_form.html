{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block content %}
    <div class="max-w-3xl mx-auto">
        <h1 class="text-xl mb-4">{% if session %}Edit{% else %}Track{% endif %} Practice Session</h1>
        <form method="post" novalidate>
            {% csrf_token %}
            
            <!-- Practice Type Field -->
            <div class="mb-4">
                <label for="{{ form.practice_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.practice_type.label }}
                </label>
                {{ form.practice_type }}
                {% if form.practice_type.errors %}
                    <div class="text-red-500 text-sm mt-1">{{ form.practice_type.errors }}</div>
                {% endif %}
            </div>
            
            <!-- Outcome Field -->
            <div class="mb-4">
                <label for="{{ form.outcome.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.outcome.label }}
                </label>
                {{ form.outcome }}
                {% if form.outcome.errors %}
                    <div class="text-red-500 text-sm mt-1">{{ form.outcome.errors }}</div>
                {% endif %}
            </div>
            
            <!-- Notes Field with Enhancement Button -->
            <div class="mb-4">
                <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.notes.label }}
                </label>
                <div class="relative">
                    {{ form.notes }}
                    <div class="mt-2">
                        <button 
                            type="button" 
                            id="enhance-notes-btn"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center gap-2"
                            onclick="enhanceNotes()"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <span>Enhance Notes</span>
                        </button>
                    </div>
                </div>
                {% if form.notes.errors %}
                    <div class="text-red-500 text-sm mt-1">{{ form.notes.errors }}</div>
                {% endif %}
                <div id="enhance-notes-error" class="text-red-500 text-sm mt-1 hidden"></div>
            </div>
            
            <div class="flex justify-between">
                <div class="w-1/3">
                    <c-a-button severity="secondary" href="{% if session %}{% url 'practice:session_detail' id=session.pk %}{% else %}{% url 'practice:practice_list' %}{% endif %}">
                    Cancel
                    </c-a-button>
                </div>
                <div class="w-1/3">
                    <c-button severity="primary" type="submit">Save Session</c-button>
                </div>
            </div>
        </form>
    </div>
    
    <script>
    function enhanceNotes() {
        const btn = document.getElementById('enhance-notes-btn');
        const notesTextarea = document.getElementById('id_notes');
        const practiceTypeSelect = document.getElementById('id_practice_type');
        const errorDiv = document.getElementById('enhance-notes-error');
        
        const notes = notesTextarea.value.trim();
        const practiceType = practiceTypeSelect.options[practiceTypeSelect.selectedIndex]?.text || '';
        
        if (!notes) {
            errorDiv.textContent = 'Please enter some notes before enhancing.';
            errorDiv.classList.remove('hidden');
            return;
        }
        
        // Set loading state
        btn.disabled = true;
        btn.innerHTML = `
            <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span>Enhancing...</span>
        `;
        errorDiv.classList.add('hidden');
        
        // Make API call
        fetch('{% url "practice:enhance_notes" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                notes: notes,
                practice_type: practiceType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.enhanced_notes) {
                notesTextarea.value = data.enhanced_notes;
            } else if (data.error) {
                errorDiv.textContent = data.error;
                errorDiv.classList.remove('hidden');
            }
        })
        .catch(error => {
            errorDiv.textContent = 'An error occurred while enhancing notes.';
            errorDiv.classList.remove('hidden');
        })
        .finally(() => {
            // Reset button state
            btn.disabled = false;
            btn.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <span>Enhance Notes</span>
            `;
        });
    }
    </script>
{% endblock content %}