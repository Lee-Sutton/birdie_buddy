{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block content %}
    <div class="max-w-3xl mx-auto" x-data="notesEnhancer()">
        <h1 class="text-xl mb-4">
            {% if session %}
                Edit
            {% else %}
                Track
            {% endif %}
            Practice Session
        </h1>
        <form method="post" novalidate id="practice-form">
            {% csrf_token %}
            <!-- Practice Type Field -->
            <div class="mb-4">
                {{ form.practice_type|as_crispy_field }}
            </div>
            <!-- Outcome Field -->
            <div class="mb-4">
                {{ form.outcome|as_crispy_field }}
            </div>
            <!-- Notes Field with EasyMDE Editor -->
            <div class="mb-4">
                <label for="id_notes" class="block text-sm font-medium text-gray-700 mb-1">{{ form.notes.label }}</label>
                <div class="relative">
                    <!-- Textarea for EasyMDE to attach to -->
                    <textarea name="notes" id="id_notes">{{ form.notes.value|default:'' }}</textarea>
                    <div class="mt-2">
                        <button type="button"
                                class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center gap-2"
                                :disabled="loading"
                                @click="enhanceNotes()">
                            <template x-if="!loading">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </template>
                            <template x-if="loading">
                                <svg class="w-4 h-4 animate-spin"
                                     fill="none"
                                     stroke="currentColor"
                                     viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                            </template>
                            <span x-text="loading ? 'Enhancing...' : 'Enhance Notes'"></span>
                        </button>
                    </div>
                </div>
                {% if form.notes.errors %}<div class="text-red-500 text-sm mt-1">{{ form.notes.errors }}</div>{% endif %}
                <div x-show="error"
                     x-transition
                     class="text-red-500 text-sm mt-1"
                     x-text="error"></div>
            </div>
            <div class="flex justify-between">
                <div class="w-1/3">
                    <c-a-button severity="secondary" href="{% if session %}{% url 'practice:session_detail' id=session.pk %}{% else %}{% url 'practice:practice_list' %}{% endif %}">
                        Cancel
                    </c-a-button>
                </div>
                <div class="w-1/3">
                    <c-button severity="primary" type="submit">
                        Save Session
                    </c-button>
                </div>
            </div>
        </form>
    </div>
    <script>
    // Alpine.js component for notes enhancement
    function notesEnhancer() {
        return {
            loading: false,
            error: null,
            
            enhanceNotes() {
                const practiceTypeSelect = document.getElementById('id_practice_type');
                
                // Get content from global EasyMDE editor
                if (!window.easyMDE) {
                    this.error = 'Editor not initialized. Please refresh the page.';
                    return;
                }
                
                const notes = window.easyMDE.value().trim();
                const practiceType = practiceTypeSelect.options[practiceTypeSelect.selectedIndex]?.text || '';
                
                if (!notes) {
                    this.error = 'Please enter some notes before enhancing.';
                    return;
                }
                
                this.loading = true;
                this.error = null;
                
                fetch('{% url "practice:enhance_notes" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify({
                        notes: notes,
                        practice_type: practiceType
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.enhanced_notes) {
                        // Set the enhanced notes in the editor
                        window.easyMDE.value(data.enhanced_notes);
                    } else if (data.error) {
                        this.error = data.error;
                    }
                })
                .catch(error => {
                    this.error = 'An error occurred while enhancing notes.';
                })
                .finally(() => {
                    this.loading = false;
                });
            }
        }
    }
    </script>
{% endblock content %}
